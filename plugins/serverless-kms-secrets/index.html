<!DOCTYPE html> <html> <head> <script type="text/javascript"> var host = 'www.serverlessconsultants.com'; if (host == window.location.host && window.location.protocol != 'https:') { window.location.protocol = 'https'; } </script> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <meta name="description" content=""> <meta name="author" content="Serverless Directory"> <meta name="msvalidate.01" content="0C81C6A5BD3BAF86F4730D8C4A9BF223" /> <meta name="google-site-verification" content=""> <title>Serverless Kms Secrets - Serverless Plugin Directory</title> <!-- Google+ Authorship --> <link rel="author" href="Serverless Directory"> <link rel="publisher" href="Serverless Directory"> <!-- Canonical --> <link rel="canonical" href="https://www.serverlessconsultants.com/plugins/serverless-kms-secrets/"> <!-- Fonts --> <link href='https://fonts.googleapis.com/css?family=Libre+Franklin:400,100,100italic,200,200italic,300,300italic,400italic,500,600,500italic,600italic,700,700italic,800,900,800italic,900italic' rel='stylesheet' type='text/css'> <link href='https://fonts.googleapis.com/css?family=PT+Sans+Caption:400,700' rel='stylesheet' type='text/css'> <link href='https://fonts.googleapis.com/css?family=Patrick+Hand+SC' rel='stylesheet' type='text/css'> <!-- Styles --> <link rel="stylesheet" href=" /css/main.css "> <!-- Feed --> <link rel="alternate" type="application/rss+xml" title="ServerLess Directory" href="https://www.serverlessconsultants.com /feed.xml "> <!-- Fav Icon and Apple Touch Icons --> <link rel="icon" type="image/png" href="/img/favicon.png" sizes="128x128" /> <meta name="application-name" content="ServerLess Directory" /> <!-- Open Graph --> <meta property="og:title" content="Serverless Kms Secrets - Serverless Plugin Directory"> <meta property="og:site_name" content="ServerLess Directory"> <meta property="og:type" content="website"> <meta property="og:description" content="Open Issue Count: 1, Stargazer Count: 32, Forks Count: 5, Watchers Count: 32."> </head> <script type="text/javascript"> (function(i, s, o, g, r, a, m) { i['GoogleAnalyticsObject'] = r; (i[r] = i[r] || function() { (i[r].q = i[r].q || []).push(arguments); }), (i[r].l = 1 * new Date()); (a = s.createElement(o)), (m = s.getElementsByTagName(o)[0]); a.async = 1; a.src = g; m.parentNode.insertBefore(a, m); })( window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga' ); ga('create', 'UA-61052500-12', 'auto'); ga('send', 'pageview'); </script> <body> <!-- Navigation --> <header class="bg-white w-100 ph3 pv3 pv4-ns ph4-m ph5-l z-999 bb b--light-gray"> <nav class="tc"> <a class="dib no-underline v-mid tc bw1 ba b gold ph1 pv2 outline b--gold" href="/" rel="nofollow"> <div>SRVR</div> <div>LSS</div> </a> <a class="link dim black b f6 f5-ns dib mr3" href="/" title="Serverless Directory">Serverless Directory</a> <a class="link dim gray f6 f5-ns dib mr3" href="/plugins/">Serverless Plugins</a> <a class="link dim gray f6 f5-ns dib mr3" href="/frameworks/">Serverless Frameworks</a> <!-- <a class="link dim gray f6 f5-ns dib mr3" href="/consultants/">Serverless Consultants</a> --> <!-- <a class="link dim gray f6 f5-ns dib mr3" href="/contact" title="Contact Serverless Frameworks Directory">Contact</a> --> </nav> </header> <div class="mw8 center"> <h1 class="tc ma0">Serverless Kms Secrets</h1> <div class="tc"> <a rel="nofollow noreferrer noopener" href="https://github.com/SC5/serverless-kms-secrets"> <img src="https://icon.now.sh/home" alt="homepage icon"> https://github.com/SC5/serverless-kms-secrets </a> </div> <article class="ph3 ph5-ns"> <h3 class="f6 ma0 pa0 ttu tc tracked">Tracked</h3> <div class="cf tc"> <dl title="NPM Downloads Last Month: 1163" class="db tc mb0 dib-l w-auto-l lh-title mr5-l"> <dd class="f6 fw4 ml0">NPM Downloads Last Month</dd> <dd class="f3 fw6 ml0">1163</dd> </dl> <dl title="Open Issue Count: 1" class="fl fn-l w-50 mb0 dib-l w-auto-l lh-title mr5-l"> <dd class="f6 fw4 ml0">Issues</dd> <dd class="f3 fw6 ml0">1</dd> </dl> <dl title="Stargazer Count: 32" class="fl fn-l w-50 dib-l mb0 w-auto-l lh-title mr5-l"> <dd class="f6 fw4 ml0">Stars</dd> <dd class="f3 fw6 ml0">32</dd> </dl> <dl title="Forks Count: 5" class="fl fn-l w-50 dib-l w-auto-l mb0 lh-title mr5-l"> <dd class="f6 fw4 ml0">Forks</dd> <dd class="f3 fw6 ml0">5</dd> </dl> <dl title="Watchers Count: 32" class="fl fn-l w-50 dib-l w-auto-l mb0 lh-title"> <dd class="f6 fw4 ml0">Watchers</dd> <dd class="f3 fw6 ml0">32</dd> </dl> </div> </article> <!-- TODO: FIX THIS --> <div class="cf tc mw6 center dn"> </div> </div> <h3 class="tc">Repo README Contents:</h3> <section class="mw8 center ph3 pv2 overflow-x-scroll ba br3" id="readme-content"> <h1 id="serverless-kms-secrets">Serverless KMS Secrets</h1> <p>A Serverless Plugin for the <a href="http://www.serverless.com">Serverless Framework</a> which helps with encrypting service secrets using the AWS Key Management Service (KMS)</p> <h2 id="introduction">Introduction</h2> <p>This plugins does the following:</p> <ul> <li>It provides commands to encrypt and decrypt secrets with KMS</li> </ul> <h2 id="installation-and-configuration">Installation and configuration</h2> <p>In your service root, run:</p> <div class="language-bash highlighter-rouge"><pre class="highlight"><code>npm install --save-dev serverless-kms-secrets
</code></pre></div> <p>Add the plugin to <code class="highlighter-rouge">serverless.yml</code>:</p> <div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="s">plugins</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">serverless-kms-secrets</span>
</code></pre></div> <p>Configure the plugin into the custom block in <code class="highlighter-rouge">serverless.yml</code>. For example:</p> <div class="language-yml highlighter-rouge"><pre class="highlight"><code><span class="s">custom</span><span class="pi">:</span>
  <span class="s">serverless-kms-secrets</span><span class="pi">:</span>
    <span class="s">secretsFile</span><span class="pi">:</span> <span class="s">kms-secrets.${opt:stage, self:provider.stage}.${opt:region, self:provider.region}.yml (optional)</span>
  <span class="s">kmsSecrets</span><span class="pi">:</span> <span class="s">${file(kms-secrets.${opt:stage, self:provider.stage}.${opt:region, self:provider.region}.yml)}</span>
</code></pre></div> <p>By default, the plugin creates secrets to the file kms-secrets.[stage].[region].yml. This can be overriden with the secretsFile parameter in the serverless-kms-secrets configuration.</p> <p>Add Decrypt permissions to your lambda function with e.g. this block in IamRoleStatements:</p> <div class="language-yml highlighter-rouge"><pre class="highlight"><code>    <span class="pi">-</span> <span class="s">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
      <span class="s">Action</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">KMS:Decrypt</span>
      <span class="s">Resource</span><span class="pi">:</span> <span class="s">${self:custom.kmsSecrets.keyArn}</span> 
</code></pre></div> <h2 id="usage">Usage</h2> <h3 id="creating-kms-key">Creating KMS Key</h3> <p>Create a KMS key in AWS IAM service, under Encryption keys. Collect the key id, which is the remaining part of the key ARN.</p> <h3 id="encrypting-variables">Encrypting Variables</h3> <p>To encrypt a variable using the key defined in the configuration, enter</p> <div class="highlighter-rouge"><pre class="highlight"><code>sls encrypt -n VARIABLE_NAME -v myvalue [-k keyId]
</code></pre></div> <p>e.g.</p> <div class="highlighter-rouge"><pre class="highlight"><code>sls encrypt -n SLACK_API_TOKEN -v xoxp-1234567890-1234567890-123467890-a12346 -k 999999-9999-99999-999
</code></pre></div> <p>The keyid (-k) parameter is mandatory for the first encrypted variable, but optional for the later ones (will be read from the secrets file). The encrypted variable is written to your secrets file (kms-secrets.[stage].[region].yml by default)</p> <p>You may also pack multiple secrets into one KMS encrypted string. This simplifies consuming the secrets in the Lambda function since all secrets can be decrypted with one single KMS.Decrypt call. To encrypt multiple secrets into one single string, use the following notation:</p> <div class="highlighter-rouge"><pre class="highlight"><code>sls encrypt -n VARIABLE_NAME:SECRET_NAME -v myvalue [-k keyId]
</code></pre></div> <p>e.g.</p> <div class="highlighter-rouge"><pre class="highlight"><code>sls encrypt -n SECRETS:SLACK_API_TOKEN -v xoxp-1234567890-1234567890-123467890-a12346 -k 999999-9999-99999-999
</code></pre></div> <p>Would encrypt and add the SLACK_API_TOKEN into the (JSON) secret SECRETS.</p> <p>NOTE: you may get warnings about the missing kms-secrets file when encrypting your first variables for a specific stage / region. The warning will go away once the file has been created by the plugin.</p> <h3 id="decrypting-variables">Decrypting Variables</h3> <p>The variables in the secrets file can be decrypted using</p> <div class="highlighter-rouge"><pre class="highlight"><code>sls decrypt [-n VARIABLE_NAME]
</code></pre></div> <p>The -n option is optional. Without that, all variables are decrypted and displayed in clear text on the console.</p> <h3 id="using-variables">Using variables</h3> <p>Pass the variables stored in the secrets file e.g. as environment variables using</p> <div class="language-yml highlighter-rouge"><pre class="highlight"><code>  <span class="s">environment</span><span class="pi">:</span>
    <span class="s">MY_VARIABLE</span><span class="pi">:</span> <span class="s">${self:custom.kmsSecrets.secrets.MY_VARIABLE}</span>
</code></pre></div> <p>The variable must be decrypted in the Lambda function using the KMS decrypt method. E.g.</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="nx">kms</span><span class="p">.</span><span class="nx">decrypt</span><span class="p">({</span>
  <span class="na">CiphertextBlob</span><span class="p">:</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">MY_VARIABLE</span><span class="p">,</span> <span class="s1">'base64'</span><span class="p">)</span>
<span class="p">}).</span><span class="nx">promise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">decrypted</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">Plaintext</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div> <p>If MY_VARIABLE consists of multiple variables, decode it using</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code>  <span class="kr">const</span> <span class="nx">secrets</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">decrypted</span><span class="p">);</span>
</code></pre></div> <h2 id="todo">TODO</h2> <ul> <li>Add support for sls deploy (deploy as KMS encrypted environment variables)</li> <li>Ease configuration (KeyIds / Arns in various places)</li> </ul> <h2 id="release-history">Release History</h2> <ul> <li>2017/09/09 - v1.0.0 - Add support for multisecret structures</li> <li>2017/05/13 - v0.9.0 - Initial version</li> </ul> <h2 id="license">License</h2> <p>Copyright (c) 2017 <a href="http://sc5.io/">SC5</a>, licensed for users and contributors under MIT license. https://github.com/SC5/serverless-kms-secrets/blob/master/LICENSE</p> </section> <footer class="cf w-100"> <div class="cover bg-left bg-center-l pv5" style="background-image: url(/img/bg.png)"> <form action="//tachyonstemplates.us16.list-manage.com/subscribe/post?u=3ff847fac68c99ba4cbf378be&amp;id=8eb026def6" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="center pa3" target="_blank" novalidate> <div> <h3 class="pa0 f3 f2-ns mb3 mt0 white tc">Want more Serverless?</h3> <h5 class="pa0 f4 f3-ns mb3 white tc">Subscribe to our mailing list to receive an update when new items arrive!</h5> <div class="cf mw7 center"> <label class="clip" for="email-address">Email Address</label> <input placeholder="Your Email Address" type="email" name="EMAIL" class="f6 f5-l input-reset bn fl black-80 bg-white pa3 lh-solid w-100 w-75-m w-80-l br2-ns br--left-ns"> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups--> <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_3ff847fac68c99ba4cbf378be_8eb026def6" tabindex="-1" value=""></div> <input class="f6 f5-l button-reset fl pv3 tc bn bg-animate bg-black-70 hover-bg-black white pointer w-100 w-25-m w-20-l br2-ns br--right-ns" name="subscribe" type="submit" value="Subscribe"> </div> </div> </form> </div> <div class="pb4 pt2 ph3 ph5-ns tc lh-copy"> <a class="pv2 db ph3 dim" href="/">Serverless Directory - Plugins, Frameworks, Consultants</a> <a class="pv2 db ph3 dim" href="/frameworks/">Serverless Frameworks Directory</a> <a class="pv2 db ph3 dim" href="/plugins/">Serverless Plugin Directory</a> <a class="pv2 db ph3 dim" href="/plugins/topics/">Serverless Plugin Topics</a> </div> </footer> <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script> <!-- keeping this here for prosperity --> </body> </html>
